# KiBot configuration file for KDT_Hierarchical Template
# KiCad 8.0

kibot:
  version: 1

filters:
  - name: only_testpoints
    comment: "Select only testpoints"
    type: generic
    include_only:
      - column: Reference
        regex: "TP"

global:
  out_dir: 'Generated'
  filters:
    - filter: 'Ignore environment.vars missing. kibot#528'
      number: 9
    - filter: Ignore missing KiCad 3D models, not in docker images
      number: 10
    - filter: 'Ignore multiple schematics warning (hierarchical schematic). kibot#594'
      number: 44


preflight:
  update_xml: true
#   check_zone_fills: true
#   # Save ERC and DRC reports in Reports folders, in both HTML
#   erc:
#     category: 'Schematics'
#     dir: 'Reports'
#     format: 'HTML, RPT'
#     output: 'report_%f-%i%I%v.%x'
#   drc:
#     category: 'PCB'
#     dir: 'Reports'
#     format: 'HTML, RPT'
#     output: 'report_%f-%i%I%v.%x'

outputs:

# # Schematic PDF
# - name: pdf_schematic
#   comment: Schematic in PDF format
#   type: pdf_sch_print
#   dir: Schematic
#   options:
#     background_color: true
#     color_theme: 'Altium_Theme'

- name: netlist
  comment: Schematic netlist in KiCad format
  type: netlist

# Interactive HTML Bill Of Materials
- name: html_bom_interactive
  comment: Interactive BOM in HTML format
  type: ibom
  dir: Manufacturing/Assembly
  options:
    extra_data_file: '%F.net'
    dark_mode: true
    show_fields: 'Value,Footprint,Manufacturer Part Number'
    group_fields: 'Value,Manufacturer Part Number'
    show_fabrication: true
    highlight_pin1: "selected"

# Classical CSV BOM
# Make sure to update PCB from schematic to get correct fields
- name: csv_bom
  comment: Bill of Materials in CSV format
  type: bom
  dir: Manufacturing/Assembly
  options:
    format: CSV
    csv:
      hide_pcb_info: true
      hide_stats_info: true
    group_fields: ['Manufacturer Part Number']

    columns:
      - "Row"
      - "Quantity Per PCB"
      - "References"
      - "Value"
      - "Datasheet"
      - "Footprint"
      - "Description"
      - "Manufacturer"
      - "Manufacturer Part Number"
      - "Supplier 1"
      - "Supplier Part Number 1"


# XLSX BOM with costs
- name: xlsx_costs_bom
  comment: Costs Bill of Materials in XLSX format
  type: bom
  dir: Manufacturing/Assembly
  options:
    format: XLSX
    count_smd_tht: true
    xlsx:
      title: 'Bill of Materials'
      logo: false
      style: modern-green
      kicost: true
      # specs: true
      # kicost_api_disable: KitSpace
    # pre_transform: _kicost_rename


# Gerbers (layers)
- name: gbr_gerbers
  comment: Gerbers in GBR format
  type: gerber
  category: 'PCB/Fabrication/Gerbers'
  dir: Manufacturing/Fabrication/Gerbers
  layers: ['copper', 'Edge.Cuts', 'F.Silkscreen', 'F.Mask', 'F.Paste', 'B.Silkscreen', 'B.Mask', 'B.Paste']
  options:
    subtract_mask_from_silk: true
    plot_footprint_refs: false
    plot_footprint_values: false

# Excellon drill map
- name: dxf_drill_map
  comment: Drill in Excellon format
  type: excellon
  category: 'PCB/Fabrication/Gerbers'
  dir: Manufacturing/Fabrication/Gerbers
  options:
    pth_and_npth_single_file: true
    map: 'dxf'
    output: '%f-PTH%I%v.%x' # will be overwritten with next step

# Excellon drill map
- name: drl_pth_npth
  comment: Drill in Excellon format
  type: excellon
  category: 'PCB/Fabrication/Gerbers'
  dir: Manufacturing/Fabrication/Gerbers
  options:
    pth_and_npth_single_file: false
    pth_id: 'PTH'
    npth_id: 'NPTH'

# Testpoints XLSX
- name: xlsx_testpoints
  comment: "Testpoint report"
  type: bom
  dir: Testing/Testpoints
  options:
    output: '%f-testpoints%I%v.%x'
    pre_transform: ['_kicost_rename']
    exclude_filter: 'only_testpoints'
    dnf_filter: '_null'
    exclude_marked_in_sch: false
    group_fields: []
    sort_style: ref
    use_aux_axis_as_origin: true
    ignore_dnf: false
    format: XLSX
    xlsx:
      title: 'Testpoints Report'
      logo: false
    footprint_type_values: 'SMT,THRU,'
    columns:
      - field: References
        name: Testpoint Ref.
      - field: Net Name
        name: Net
      - field: Net Class        
      - field: Footprint X
        name: X
      - field: Footprint Y
        name: Y
      - field: Footprint Side
        name: Side
      - field: Footprint Type
        name: Pad Type
      - field: Value
      - field: Footprint

# Testpoints CSV
- name: csv_testpoints
  comment: "Testpoint report in CSV format"
  type: bom
  dir: Testing/Testpoints
  options:
    output: '%f-testpoints%I%v.%x'
    pre_transform: ['_kicost_rename']
    exclude_filter: 'only_testpoints'
    dnf_filter: '_null'
    exclude_marked_in_sch: false
    group_fields: []
    sort_style: ref
    use_aux_axis_as_origin: true
    ignore_dnf: false
    format: CSV
    footprint_type_values: 'SMT,THRU,'
    columns:
      - field: References
        name: Testpoint Ref.
      - field: Net Name
        name: Net
      - field: Net Class        
      - field: Footprint X
        name: X
      - field: Footprint Y
        name: Y
      - field: Footprint Side
        name: Side
      - field: Footprint Type
        name: Pad Type
      - field: Value
      - field: Footprint

# # Fabrication PDF file
# - name: pdf_fabrication_top
#   comment: Fabrication Top document in PDF format
#   type: pcb_print
#   category: Manufacturing/Fabrication
#   dir: Manufacturing/Fabrication
#   options:
#     color_theme: 'Altium_Theme'
#     output: '%f-fabrication_top%I%v.%x'
#     format: 'PDF'
#     title: 'Fabrication Document'
#     realistic_solder_mask: false
#     dpi: 1200
#     dnf_filter: _kibom_dnf_Config
#     # sheet_reference_layout: "${KIPRJMOD}/Templates/XRE_Legged_Template_Fab.kicad_wks"

#     pages:
#       - scaling: 1.0
#         page_id: '1'
#         title: Top Fabrication
#         sheet: Top Fabrication
#         sheet_reference_color: '#000000'
#         colored_holes: true
#         holes_color: "#FFFFFF"
#         layers:
#           - layer: Edge.Cuts
#             color: '#000000'
#           - layer: F.Cu
#             color: '#F2F2F2'
#           - layer: F.Mask
#             color: '#E2E2E2'
#           - layer: F.Paste
#             color: '#E2E2E2'
#           - layer: F.Silkscreen
#             color: '#DBDBDB'
#           - layer: F.Fab
#             plot_footprint_refs: false
#             plot_footprint_values: false
#             color: '#818181'
#           - layer: User.6
#             description: Top Dimensions
#             color: '#000000'

# - name: pdf_fabrication_bottom
#   comment: Fabrication Bottom document in PDF format
#   type: pcb_print
#   category: Manufacturing/Fabrication
#   dir: Manufacturing/Fabrication
#   options:
#     color_theme: 'Altium_Theme'
#     output: '%f-fabrication_bottom%I%v.%x'
#     format: 'PDF'
#     title: 'Fabrication Document'
#     realistic_solder_mask: false
#     dpi: 1200
#     dnf_filter: _kibom_dnf_Config
#     # sheet_reference_layout: "${KIPRJMOD}/Templates/XRE_Legged_Template_Fab.kicad_wks"

#     pages:
#       - scaling: 1.0
#         mirror: true
#         mirror_pcb_text: false
#         page_id: '2'
#         title: Bottom Fabrication
#         sheet: Bottom Fabrication
#         sheet_reference_color: '#000000'
#         colored_holes: true
#         holes_color: "#FFFFFF"
#         layers:
#           - layer: Edge.Cuts
#             color: '#000000'
#           - layer: B.Cu
#             color: '#F2F2F2'
#           - layer: B.Mask
#             color: '#E2E2E2'
#           - layer: B.Paste
#             color: '#E2E2E2'
#           - layer: B.Silkscreen
#             color: '#DBDBDB'
#           - layer: B.Fab
#             plot_footprint_refs: false
#             plot_footprint_values: false
#             color: '#818181'
#           - layer: User.7
#             description: Bottom Dimensions
#             color: '#000000'

- name: pdf_fabrication_layers
  comment: Fabrication Layers PDF format
  type: pcb_print
  category: Manufacturing/Fabrication
  dir: Manufacturing/Fabrication
  options:
    # color_theme: 'Altium_Theme'
    colored_pads: false
    colored_vias: false
    output: '%f-fabrication_layers%I%v.%x'
    format: 'PDF'
    title: 'Fabrication Document'
    realistic_solder_mask: false
    dpi: 1200
    dnf_filter: _kibom_dnf_Config
    # sheet_reference_layout: "${KIPRJMOD}/Templates/XRE_Legged_Template_Fab.kicad_wks"

    pages:
      - scaling: 1.0
        page_id: '1'
        title: Fabrication Layers
        sheet: L1 (Sig, PWR)
        sheet_reference_color: '#000000'
        colored_holes: true
        holes_color: "#77D56C"
        layers:
          - layer: F.Cu
            color: '#CA0000'
          # - layer: F.Fab
          #   plot_footprint_refs: false
          #   plot_footprint_values: false
          #   color: '#818181'
      - scaling: 1.0
        page_id: '2'
        title: Fabrication Layers
        sheet: L1 (Sig, PWR)
        sheet_reference_color: '#000000'
        colored_holes: true
        holes_color: "#77D56C"
        layers:
          - layer: F.Cu
            color: '#CA0000'
          - layer: F.Fab
            plot_footprint_refs: false
            plot_footprint_values: false
            color: '#818181'     

# # Assembly PDF file
# - name: pdf_assembly_top
#   comment: Assembly Top document in PDF format
#   type: pcb_print
#   category: Manufacturing/Assembly
#   dir: Manufacturing/Assembly
#   options:
#     color_theme: 'Altium_Theme'
#     output: '%f-assembly_top%I%v.%x'
#     format: 'PDF'
#     title: 'Assembly Document'
#     realistic_solder_mask: false
#     dpi: 1200
#     dnf_filter: _kibom_dnf_Config
#     # sheet_reference_layout: "${KIPRJMOD}/Templates/XRE_Legged_Template_Fab.kicad_wks"

#     pages:
#       - scaling: 1.0
#         page_id: '1'
#         title: Top Assembly
#         sheet: Top Assembly
#         sheet_reference_color: '#000000'
#         colored_holes: true
#         holes_color: "#FFFFFF"
#         layers:
#           - layer: Edge.Cuts
#             color: '#000000'
#           - layer: F.Cu
#             color: '#EEDAB5'
#           - layer: F.Mask
#             color: '#B9B9B9'
#           - layer: F.Paste
#             color: '#E1A98E'
#           - layer: F.Silkscreen
#             color: '#DB9DE1'
#           - layer: F.Fab
#             color: '#744679'
#           - layer: User.4
#             description: Top Assembly Text
#             color: '#000000'

# - name: pdf_assembly_bottom
#   comment: Assembly Bottom document in PDF format
#   type: pcb_print
#   category: Manufacturing/Assembly
#   dir: Manufacturing/Assembly
#   options:
#     color_theme: 'Altium_Theme'
#     output: '%f-assembly_bottom%I%v.%x'
#     format: 'PDF'
#     title: 'Assembly Document'
#     realistic_solder_mask: false
#     dpi: 1200
#     dnf_filter: _kibom_dnf_Config
#     # sheet_reference_layout: "${KIPRJMOD}/Templates/XRE_Legged_Template_Fab.kicad_wks"

#     pages:
#       - scaling: 1.0
#         mirror: true
#         mirror_pcb_text: false
#         page_id: '2'
#         title: Bottom Assembly
#         sheet: Bottom Assembly
#         sheet_reference_color: '#000000'
#         colored_holes: true
#         holes_color: "#FFFFFF"
#         layers:
#           - layer: Edge.Cuts
#             color: '#000000'
#           - layer: B.Cu
#             color: '#D5DBF4'
#           - layer: B.Mask
#             color: '#B9B9B9'
#           - layer: B.Paste
#             color: '#BCB9DD'
#           - layer: B.Silkscreen
#             color: '#DB9DE1'
#           - layer: B.Fab
#             color: '#400080'
#           - layer: User.5
#             description: Bottom Assembly Text
#             color: '#000000'
        


# Fabrication output ZIP file (contains drill map DXF)
- name: compress_gerbers
  comment: Generates a ZIP file with .gbr and .drl fabrication files
  type: compress
  category: Manufacturing/Fabrication/Gerbers
  dir: Manufacturing/Fabrication
  options:
    output: '%f-GERBERS%I%v.%x'
    move_files: true
    files:
      - source: 'Manufacturing/Fabrication/Gerbers/*'
        dest: '/'

# Position file for Pick & Place
- name: csv_position
  comment: Position file in CSV format
  type: position
  category: Manufacturing/Assembly
  dir: Manufacturing/Assembly
  options:
    format: 'CSV'
    only_smd: false # IMPORTANT TO CHANGE IF NECESSARY
    output: '%f-CPL%I%v.%x'
    separate_files_for_front_and_back: false

